<!DOCTYPE html>
<html lang="en">
    <meta charset="utf-8">  
	<!--<link rel="stylesheet" href="/path/to/flickity.css" media="screen">-->
	<!--<script src="/path/to/flickity.pkgd.min.js"></script>-->
	<link rel="stylesheet" href="styles.css" media="screen">
	<style>#map-canvas{ width: 200px; height: 200px; display: block; }</style>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxYJTC2MrJe_f-6b53TiaaHjonWC0EPxg"></script>
    <script>
    $(document).ready(function() {
		// Flickr API key
		var key = "a86e25fd6e699aad4601106467321bf3";
		
        // LINZ Data Service API Key
        var ldsApiKey = "e37f7e03afd44129b1186e7f7640effb";

        // The Layer ID of the layer we're querying
        var ldsLayerID = 364;
		
		// Maximum number of results to be returned (1-100)
		var maxResults = 100;
		
		// Latitude of map centre
		var latitudeCentre = -36.977587;
		
		// Longitude of map centre
		var longitudeCentre = 174.528961;
		
		// Array of all tracks returned from API
		var myTracks = [];
		
        //Adds a message to the `messageNode`
        var logMessage = function(text) {
            var newNode = $('<li>');
            newNode.text(text);
            $('#messages').append(newNode);
        }

		// Find a track using its ID, and return that track object
		var getTrackByID = function(id){
			for (var i = 0; i < myTracks.length; i++) {
				if (myTracks[i].id == id) {
					return myTracks[i];
				}
			}
		}
		
		// Saves geographical data obtained from API call to be used later
		var processData = function(data) {
			// Loop through all tracks and store all non-null-named tracks in an array of objects
			for (var i = 0, j = 0; i < maxResults; i++) {
				// Name of track from API
				var trackName = data.vectorQuery.layers["364"].features[i].properties.name;
				// Array of track coordinates from API
				var trackCoordinates = data.vectorQuery.layers["364"].features[i].geometry.coordinates;
				// Check if track has a name
				if (trackName != null) {
					var totalLength=0;
					distanceToWalk=lengthOfWalk(realLat,realLon,trackCoordinates[0][0],trackCoordinates[0][1]);
					// Find total length of track in km
					for (var z = 0; z < trackCoordinates.length-1; z++) { 
						var ArrayLat=new Array(trackCoordinates.length);
						var ArrayLong=new Array(trackCoordinates.length);
						ArrayLat[z]=trackCoordinates[z][0];
						ArrayLong[z]=trackCoordinates[z][1];
						ArrayLat[z+1]=trackCoordinates[z+1][0];
						ArrayLong[z+1]=trackCoordinates[z+1][1];
						var x=lengthOfWalk(ArrayLat[z],ArrayLong[z],ArrayLat[z+1],ArrayLong[z+1]);
						totalLength=totalLength+x;
					}		
					
					// Calculate time to walk the track
					var walkingTime = totalLength/0.036;
				
					// Save track variable with associated variables
					var	track = {
						id: j,
						name: trackName,
						coordinates: trackCoordinates,
						trackLength: totalLength,
						timeInMinutes: walkingTime,
						distanceToWalk: distanceToWalk
					};
					myTracks.push(track);
					j++;
				}
			}
		}
		
		// Filters out 'null' named tracks and displays the name of all other tracks
		var displayData = function() {
			var $walks = $("#walks");
			for (var i = 0; i < myTracks.length; i++){
				// Name of track from API
				var trackName = myTracks[i].name;
				var trackID = myTracks[i].id;	
				var trackLatitude = myTracks[i].coordinates[0][1];
				var trackLongitude = myTracks[i].coordinates[0][0];
				var trackLength = myTracks[i].trackLength;
				if (trackName != null) {
					getPhoto(trackName, trackLatitude, trackLongitude, 1, trackID); 
				}
			}
			$(document).on("click", "#walks a", function(ev) {
				ev.preventDefault();
				var track = getTrackByID($(this).data("track-id"));
				var $walkInfo = $("<div>Title: " + track.name + " Length: " + track.trackLength.toFixed(1) + "km<button id='closeButton'>&times;</button></div>");
				$walkInfo.append("<div id='map-canvas'></div>");
				$walkInfo.append("<ol id='photos'></ol>");
				getPhotos(track.name, track.coordinates[0][1], track.coordinates[0][0], track.id); 
				$walkInfo.append("<div id='map-canvas'></div>");
				$("#walk-info").prepend($walkInfo);
				showMap($(this).data("track-id"));
			});
			$(document).on("click", "#closeButton", function(ev) {
				ev.preventDefault();
				$(this).parent().remove();
			});
		}
		
				// Initialises Flickr API call to return images of the selected image
				var getPhoto = function(walkwayName,latitude,longitude,numberOfPhotos, trackID){
					//$('.main-gallery').flickity({
					//	// options
					//	cellAlign: 'left',
					//	contain: true
					//});
					$.getJSON('https://api.flickr.com/services/rest/?&method=flickr.photos.search&text="' + walkwayName + '"&format=json&api_key=' + key + '&per_page=' + numberOfPhotos + '&lat=' + latitude + '&lon=' + longitude + '&radius=30&radius_units=km&extras=url,geo&has_geo=1&jsoncallback=?',function(data){
						var $walks = $("#walks");
						 
						$.each(data.photos.photo, function(index, photo) {
							var imageString = "url(https://farm" + photo.farm + ".staticflickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + ".jpg)";
							//$walks.append("<li><a href='#' data-track-id='" + trackID + "'> <img src='https://farm" + photo.farm + ".staticflickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + ".jpg" + "'/> </a></li>");
							var $walk = $("<li><a href='#' data-track-id='" + trackID + "'></a></li>");
							$walk.find("a").css("background-image",imageString);
							$walks.append($walk);
						});
					})
				}
				
				var getPhotos = function(walkwayName,latitude,longitude, trackID){
					//$('.main-gallery').flickity({
					//	// options
					//	cellAlign: 'left',
					//	contain: true
					//});
					$.getJSON('https://api.flickr.com/services/rest/?&method=flickr.photos.search&text="' + walkwayName + '"&format=json&api_key=' + key + '&per_page=10&lat=' + latitude + '&lon=' + longitude + '&radius=30&radius_units=km&extras=url,geo&has_geo=1&jsoncallback=?',function(data){
						var $walks = $("#walks");
						 
						$.each(data.photos.photo, function(index, photo) {
							var imageString = "https://farm" + photo.farm + ".staticflickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + ".jpg";
							var $photo = $("<li><img src='" + imageString + "'></li>");
							$photo.find("a").css("background-image",imageString);
							$("#photos").append($photo);
						});
					})
				}
		
        // Create GET request to return track info from LINZ Data Service
        var requestName = function(lat, lon) {
		
            // Create the Deferred object.
            var deferred = $.Deferred();

            // These are our query string parameters for the API call.
            var params = {
                "key": ldsApiKey,
                "layer": ldsLayerID,
				"x": longitudeCentre,
				"y": latitudeCentre,
				"max_results": maxResults,
				"radius": 100000,
				"geometry": true,
				"with_field_names": true
            }

            // Initiate the request *asyncronously*
            var request = $.get("http://api.data.linz.govt.nz/api/vectorQuery.json", params);

            // Add a success handler, a function to be called when
            // the API returns a successful result.
            request.done(
                function(data) {
                    // PROCESS DATA FROM API HERE
					processData(data);
					displayData(data);
                }
            );

            // Add a failure handler, a function to be called when
            // the API rejects the request.
            request.fail(
                function() {
                    // When the request fails, we reject the deferred object.
                    deferred.reject()
                }
            );
            // Return the deferred. It will "resolve" or "reject" when the a
            // result is available.
            return deferred;
        }
		var realLat;
		var realLon;
		
        navigator.geolocation.getCurrentPosition(function(position) {
            logMessage("Got current position, querying data...");
			realLon=position.coords.latitude;
			realLat=position.coords.longitude;
            // Request the elevation. The function returns a deferred object --
            // REMEMBER: we won't know the result of the call until it has finished querying the
            // remote service and the deferred is resolved.
            var deferred = requestName(position.coords.latitude, position.coords.longitude);
        });
		
		// Allows us to find the distance between two coordinates
		function lengthOfWalk(lat1, lon1, lat2, lon2) {
			var R = 6371;
			var a = 
					 0.5 - Math.cos((lat2 - lat1) * Math.PI / 180)/2 + 
					 Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
					 (1 - Math.cos((lon2 - lon1) * Math.PI / 180))/2;
			return R * 2 * Math.asin(Math.sqrt(a));
		}
		
		function showMap(trackID) {
		var track = getTrackByID(trackID);		
		var mapOptions = {
		  center: { lat: track.coordinates[0][1], lng: track.coordinates[0][0] },
		  zoom: 11,
		  mapTypeId: "walkland"
		};
		
		// Custom map style
		var mapStyles = [
			{
				"featureType": "all",
				"elementType": "labels.text.stroke",
				"stylers": [
					{
						"visibility": "on"
					},
					{
						"weight": "2.55"
					},
					{
						"color": "#ffffff"
					}
				]
			},
			{
				"featureType": "landscape",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#4caf50"
					}
				]
			},
			{
				"featureType": "landscape.man_made",
				"elementType": "geometry",
				"stylers": [
					{
						"visibility": "on"
					}
				]
			},
			{
				"featureType": "landscape.natural.landcover",
				"elementType": "geometry",
				"stylers": [
					{
						"visibility": "on"
					},
					{
						"color": "#509362"
					}
				]
			},
			{
				"featureType": "landscape.natural.terrain",
				"elementType": "geometry",
				"stylers": [
					{
						"visibility": "on"
					},
					{
						"hue": "#00ff0c"
					}
				]
			},
			{
				"featureType": "poi",
				"elementType": "geometry",
				"stylers": [
					{
						"visibility": "simplified"
					},
					{
						"hue": "#00ff08"
					}
				]
			},
			{
				"featureType": "poi.park",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#388e3c"
					}
				]
			},
			{
				"featureType": "water",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#8fceec"
					}
				]
			}
		];
		
		// Create google map object
		var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		map.mapTypes.set("walkland", new google.maps.StyledMapType(mapStyles, {name: "walkland-style"}));
		var flightPlanCoordinates = [];

		for (var i = 0; i < track.coordinates.length; i++){
			flightPlanCoordinates[i] = new google.maps.LatLng(track.coordinates[i][1], track.coordinates[i][0]);
		}
		
		var flightPath = new google.maps.Polyline({
			path: flightPlanCoordinates,
			geodesic: true,
			strokeColor: '#FF0000',
			strokeOpacity: 1.0,
			strokeWeight: 2
		});
		flightPath.setMap(map);
	}
    });
	
    </script>
    <body>
		<div class="navigation-bar">
			<img src="logo.svg" id="logo">
		</div>
		<div id="walk-info"></div>
        <ol id="walks"></ol>
    </body>
</html>
