<!DOCTYPE html>
<html lang="en">
    <meta charset="utf-8">  
	<!--<link rel="stylesheet" href="/path/to/flickity.css" media="screen">-->
	<!--<script src="/path/to/flickity.pkgd.min.js"></script>-->
	<link rel="stylesheet" href="styles.css" media="screen">
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxYJTC2MrJe_f-6b53TiaaHjonWC0EPxg"></script>
    <script>
    $(document).ready(function() {
		
		// Google API Key = AIzaSyAxYJTC2MrJe_f-6b53TiaaHjonWC0EPxg
		
		// Flickr key
		var key = "a86e25fd6e699aad4601106467321bf3";
		
        // Your LINZ Data Service API Key
        var ldsApiKey = "e37f7e03afd44129b1186e7f7640effb";

        // The Layer ID of the layer we're querying
        var ldsLayerID = 364;
		
		// Maximum number of results to be returned (1-100)
		var maxResults = 100;
		
		// Latitude of map centre
		var latitudeCentre = -36.977587;
		
		// Longitude of map centre
		var longitudeCentre = 174.528961;
		
		// Array of all tracks returned from API
		var myTracks = [];
		
		// id of track selected by user
		//var selectedTrack = 0;
		
        /**
         * Adds a message to the `messageNode`
         *
         * @param text  The text, safely cleaned below.
         */
        var logMessage = function(text) {
            var newNode = $('<li>');
            newNode.text(text);
            $('#messages').append(newNode);
        }

		var getNameByID = function(id){
			for (var i = 0; i < myTracks.length; i++) {
				if (myTracks[i].id == id) {
					return myTracks[i].name;
				}
			}
		}
		
		// Saves geographical data obtained from API call to be used later
		var processData = function(data) {
			// Loop through all tracks and store all non-null-named tracks in an array of objects
			for (var i = 0, j = 0; i < maxResults; i++) {
				// Name of track from API
				var trackName = data.vectorQuery.layers["364"].features[i].properties.name;
				// Array of track coordinates from API
				var trackCoordinates = data.vectorQuery.layers["364"].features[i].geometry.coordinates;
				if (trackName != null) {
				
					var totalLength=0;
					
					distanceToWalk=lengthOfWalk(realLat,realLon,trackCoordinates[0][0],trackCoordinates[0][1]);
				
					for (var z = 0; z < trackCoordinates.length-1; z++) { 
							
						var ArrayLat=new Array(trackCoordinates.length);
						var ArrayLong=new Array(trackCoordinates.length);
							
							
						ArrayLat[z]=trackCoordinates[z][0];
						ArrayLong[z]=trackCoordinates[z][1];
						ArrayLat[z+1]=trackCoordinates[z+1][0];
						ArrayLong[z+1]=trackCoordinates[z+1][1];
							
						
						var x=lengthOfWalk(ArrayLat[z],ArrayLong[z],ArrayLat[z+1],ArrayLong[z+1]);
							
						totalLength=totalLength+x;
					}
					
					
					var walkingTime = totalLength/0.036;
				
					// Save track variable with associated variables
					var	track = {
						id: j,
						name: trackName,
						coordinates: trackCoordinates,
						trackLength: totalLength,
						timeInMinutes: walkingTime,
						distanceToWalk: distanceToWalk
					};
					
					myTracks.push(track);
					j++;
				}
			}
			//console.log(myTracks);
		}
		
		//console.log(myTracks);
		
		// Filters out 'null' named tracks and displays the name of all other tracks
		var displayData = function() {
			var $walks = $("#walks");
			for (var i = 0; i < myTracks.length; i++){
				// Name of track from API
				//console.log(myTracks[i]);
				var trackName = myTracks[i].name;
				var trackID = myTracks[i].id;	
				var trackLatitude = myTracks[i].coordinates[0][1];
				var trackLongitude = myTracks[i].coordinates[0][0];
				if (trackName != null) {
	//				$walks.append("<li>" + data.vectorQuery.layers["364"].features[i].properties.name + "</li>");
					//$walks.append("<a href='#' data-trackID='" + trackID + "'>" + trackName + "</a>");
					getPhotos(trackName, trackLatitude, trackLongitude, 1, trackID); 
					$(document).on("click", "#walks a", function(ev) {
						ev.preventDefault();
						//var walkInfo = "<div>Title: " + myTracks[i].name + " Length:";
						//$walks.append("<div>" + trackID + trackName + trackLength + "</div>");
						initialize();
					});
				}
			}
			//console.log(myTracks);
		}
		//console.log(myTracks);
		
				// Initialises Flickr API call to return images of the selected image
				var getPhotos = function(walkwayName,latitude,longitude,numberOfPhotos, trackID){
					//$('.main-gallery').flickity({
					//	// options
					//	cellAlign: 'left',
					//	contain: true
					//});
					$.getJSON('https://api.flickr.com/services/rest/?&method=flickr.photos.search&text="' + walkwayName + '"&format=json&api_key=' + key + '&per_page=' + numberOfPhotos + '&lat=' + latitude + '&lon=' + longitude + '&radius=30&radius_units=km&extras=url,geo&has_geo=1&jsoncallback=?',function(data){
						var $walks = $("#walks");
						//console.log(data);
						 
						$.each(data.photos.photo, function(index, photo) {
							var imageString = "url(https://farm" + photo.farm + ".staticflickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + ".jpg)";
							//$walks.append("<li><a href='#' data-trackID='" + trackID + "'> <img src='https://farm" + photo.farm + ".staticflickr.com/" + photo.server + "/" + photo.id + "_" + photo.secret + ".jpg" + "'/> </a></li>");
							var $walk = $("<li><a href='#' data-trackID='" + trackID + "'></a></li>");
							$walk.find("a").css("background-image",imageString);
							$walks.append($walk);
						});
					})
				}
		
        /**
         * Initiates a GET request to the LINZ Data Service for the elevation layer,
         * and returns a Deferred that will be resolved when the elevation is returned,
         * or rejected if there was an error.
         *
         * @param lat   The latitude (y) of the position (WSG84 Coordinates)
         * @param lon   The longitude (x) of the position (WSG84 Coordinates)
         * @return Deferred
         */
        var requestName = function(lat, lon) {
		
            // Create the Deferred object.
            var deferred = $.Deferred();

            // These are our query string parameters for the API call.
            var params = {
                "key": ldsApiKey,
                "layer": ldsLayerID,
     //           "x": lon,
				"x": longitudeCentre,
       //         "y": lat,
				"y": latitudeCentre,
				"max_results": maxResults,
				"radius": 100000,
				"geometry": true,
				"with_field_names": true
            }
			
			

            // Initiate the request *asyncronously*
            var request = $.get("http://api.data.linz.govt.nz/api/vectorQuery.json", params);

            // Add a success handler, a function to be called when
            // the API returns a successful result.
            request.done(
                function(data) {
                    // PROCESS DATA FROM API HERE
                //    deferred.resolve(elevation);
					//console.log(data);
					processData(data);
					displayData(data);
					//initialize();
					//console.log(myTracks);
                }
            );

            // Add a failure handler, a function to be called when
            // the API rejects the request.
            request.fail(
                function() {
                    // When the request failes, we reject the deferred object.
                    deferred.reject()
                }
            );

            // Return the deferred. It will "resolve" or "reject" when the a
            // result is available.
            return deferred;
        }

        logMessage("Getting current position...");
		
		
		var realLat;
		var realLon;
		
        navigator.geolocation.getCurrentPosition(function(position) {
            logMessage("Got current position, querying data...");
			
			realLon=position.coords.latitude;
			realLat=position.coords.longitude;

            // Request the elevation. The function returns a deferred object --
            // REMEMBER: we won't know the result of the call until it has finished querying the
            // remote service and the deferred is resolved.
            var deferred = requestName(position.coords.latitude, position.coords.longitude);

            // If we get a good result, print it:
        //    deferred.done(function(elevation) {
        //        logMessage("The elevation here is: " + elevation + "m!");
         //   });
            // Otherwise, *sadface*
            deferred.fail(function() {
                logMessage("Couldn't get the elevation here :(");
            });
        });
		
		
		
		
		/**Function to allow us to find the distance between two coordinates**/
		
		function lengthOfWalk(lat1, lon1, lat2, lon2) {
			var R = 6371;
			var a = 
					 0.5 - Math.cos((lat2 - lat1) * Math.PI / 180)/2 + 
					 Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
					 (1 - Math.cos((lon2 - lon1) * Math.PI / 180))/2;

			return R * 2 * Math.asin(Math.sqrt(a));
		}
		
		
		function initialize() {
		var mapOptions = {
		  center: { lat: latitudeCentre, lng: longitudeCentre},
		  zoom: 12
		};
		var map = new google.maps.Map(document.getElementById('map-canvas'),
			mapOptions);
			
		//var flightPlanCoordinates = [
		//	new google.maps.LatLng(-36.96809727923316, 174.51562652593555),
		//	new google.maps.LatLng(-36.97704773721164, 174.52684269985488),
		//	new google.maps.LatLng(-37.00174050001743, 174.52928740436624)
		//];		
		
		var selectedTrack = 0;
		var flightPlanCoordinates = [];
		//console.log(myTracks);
		for (var i = 0; i < myTracks[selectedTrack].coordinates.length; i++){
			flightPlanCoordinates[i] = new google.maps.LatLng(myTracks[selectedTrack].coordinates[i][1], myTracks[selectedTrack].coordinates[i][0]);
			//flightPlanCoordinates[i] = myTracks[selectedTrack].coordinates;
			//flightPlanCoordinates[i][0] = myTracks[selectedTrack].coordinates[i][1];
			//flightPlanCoordinates[i][1] = myTracks[selectedTrack].coordinates[i][0];
		}
		
		//var test = myTracks[0][0];
		//consoles.log(test);
		
		var flightPath = new google.maps.Polyline({
			path: flightPlanCoordinates,
			geodesic: true,
			strokeColor: '#FF0000',
			strokeOpacity: 1.0,
			strokeWeight: 2
		});
		
		flightPath.setMap(map);
			
		//console.log(map);
		//console.log(myTracks);
	}
	//google.maps.event.addDomListener(window, 'load', initialize);
    });
	
    </script>
    <body>
		<div id="map-canvas"></div>
        <ol id="walks"></ol>
    </body>
</html>
